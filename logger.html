<!DOCTYPE html><html><head><title>Connect - High quality middleware for node.js</title><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><link rel="stylesheet" href="style.css"><script src="jquery.js"></script><script src="docs.js"></script></head><body><div id="content"><h1>Connect</h1><div id="" class="comment"><h2></h2><div class="description"><h2>Logger</h2>

<p>Log requests with the given <code>options</code> or a <code>format</code> string.</p>

<h2>Options</h2>

<ul>
<li><code>format</code>  Format string, see below for tokens</li>
<li><code>stream</code>  Output stream, defaults to <em>stdout</em></li>
<li><code>buffer</code>  Buffer duration, defaults to 1000ms when <em>true</em></li>
<li><code>immediate</code>  Write log line on request instead of response (for response times)</li>
</ul>

<h2>Tokens</h2>

<ul>
<li><code>:req[header]</code> ex: <code>:req[Accept]</code></li>
<li><code>:res[header]</code> ex: <code>:res[Content-Length]</code></li>
<li><code>:http-version</code></li>
<li><code>:response-time</code></li>
<li><code>:remote-addr</code></li>
<li><code>:date</code></li>
<li><code>:method</code></li>
<li><code>:url</code></li>
<li><code>:referrer</code></li>
<li><code>:user-agent</code></li>
<li><code>:status</code></li>
</ul>

<h2>Formats</h2>

<p>Pre-defined formats that ship with connect:</p>

<ul>
<li><code>default</code> ':remote-addr - - [:date] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"'</li>
<li><code>short</code> ':remote-addr - :method :url HTTP/:http-version :status :res[content-length] - :response-time ms'</li>
<li><code>tiny</code>  ':method :url :status :res[content-length] - :response-time ms'</li>
<li><code>dev</code> concise output colored by response status for development use</li>
</ul>

<h2>Examples</h2>

<pre><code> connect.logger() // default
 connect.logger('short')
 connect.logger('tiny')
 connect.logger({ immediate: true, format: 'dev' })
 connect.logger(':method :url - :referrer')
 connect.logger(':req[content-type] -&gt; :res[content-type]')
 connect.logger(function(req, res){ return 'some format string' })
</code></pre>

<h2>Defining Tokens</h2>

<p>To define a token, simply invoke <code>connect.logger.token()</code> with the<br />  name and a callback function. The value returned is then available<br />  as ":type" in this case.</p>

<pre><code> connect.logger.token('type', function(req, res){ return req.headers['content-type']; })
</code></pre>

<h2>Defining Formats</h2>

<p>All default formats are defined this way, however it's public API as well:</p>

<pre><code>  connect.logger.format('name', 'string or function')
</code></pre></div><ul class="tags"><li><em>String | Function | Object</em> format or options</li><li>returns <em>Function</em> </li></ul><h3>Source</h3><pre><code>exports = module.exports = function logger(options) {
  if ('object' == typeof options) {
    options = options || {};
  } else if (options) {
    options = { format: options };
  } else {
    options = {};
  }

  // output on request instead of response
  var immediate = options.immediate;

  // format name
  var fmt = exports[options.format] || options.format || exports.default;

  // compile format
  if ('function' != typeof fmt) fmt = compile(fmt);

  // options
  var stream = options.stream || process.stdout
    , buffer = options.buffer;

  // buffering support
  if (buffer) {
    var realStream = stream
      , interval = 'number' == typeof buffer
        ? buffer
        : defaultBufferDuration;

    // flush interval
    setInterval(function(){
      if (buf.length) {
        realStream.write(buf.join(''), 'ascii');
        buf.length = 0;
      }
    }, interval); 

    // swap the stream
    stream = {
      write: function(str){
        buf.push(str);
      }
    };
  }

  return function logger(req, res, next) {
    req._startTime = new Date;

    // mount safety
    if (req._logging) return next();

    // flag as logging
    req._logging = true;

    // immediate
    if (immediate) {
      var line = fmt(exports, req, res);
      if (null == line) return;
      stream.write(line + '\n', 'ascii');
    // proxy end to output logging
    } else {
      var end = res.end;
      res.end = function(chunk, encoding){
        res.end = end;
        res.end(chunk, encoding);
        var line = fmt(exports, req, res);
        if (null == line) return;
        stream.write(line + '\n', 'ascii');
      };
    }


    next();
  };
};</code></pre></div><div id="compile" class="comment"><h2>compile()</h2><div class="description"><p>Compile <code>fmt</code> into a function.</p></div><ul class="tags"><li><em>String</em> fmt </li><li>returns <em>Function</em> </li></ul><h3>Source</h3><pre><code>function compile(fmt) {
  fmt = fmt.replace(/"/g, '\\"');
  var js = '  return "' + fmt.replace(/:([-\w]{2,})(?:\[([^\]]+)\])?/g, function(_, name, arg){
    return '"\n    + (tokens["' + name + '"](req, res, "' + arg + '") || "-") + "';
  }) + '";'
  return new Function('tokens, req, res', js);
};</code></pre></div><div id="exports.token" class="comment"><h2>exports.token()</h2><div class="description"><p>Define a token function with the given <code>name</code>,<br />and callback <code>fn(req, res)</code>.</p></div><ul class="tags"><li><em>String</em> name </li><li><em>Function</em> fn </li><li>returns <em>Object</em> exports for chaining</li></ul><h3>Source</h3><pre><code>exports.token = function(name, fn) {
  exports[name] = fn;
  return this;
};</code></pre></div><div id="exports.format" class="comment"><h2>exports.format()</h2><div class="description"><p>Define a <code>fmt</code> with the given <code>name</code>.</p></div><ul class="tags"><li><em>String</em> name </li><li><em>String | Function</em> fmt </li><li>returns <em>Object</em> exports for chaining</li></ul><h3>Source</h3><pre><code>exports.format = function(name, str){
  exports[name] = str;
  return this;
};</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>Default format.</p></div><h3>Source</h3><pre><code>exports.format('default', ':remote-addr - - [:date] ":method :url HTTP/:http-version" :status :res[content-length] ":referrer" ":user-agent"');</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>Short format.</p></div><h3>Source</h3><pre><code>exports.format('short', ':remote-addr - :method :url HTTP/:http-version :status :res[content-length] - :response-time ms');

// tiny format

exports.format('tiny', ':method :url :status :res[content-length] - :response-time ms');</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>dev (colored)</p></div><h3>Source</h3><pre><code>exports.format('dev', function(tokens, req, res){
  var status = res.statusCode
    , color = 32;

  if (status >= 500) color = 31
  else if (status >= 400) color = 33
  else if (status >= 300) color = 36;

  return '\033[90m' + req.method
    + ' ' + req.originalUrl + ' '
    + '\033[' + color + 'm' + res.statusCode
    + ' \033[90m'
    + (new Date - req._startTime)
    + 'ms\033[0m';
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>request url</p></div><h3>Source</h3><pre><code>exports.token('url', function(req){
  return req.originalUrl;
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>request method</p></div><h3>Source</h3><pre><code>exports.token('method', function(req){
  return req.method;
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>response time in milliseconds</p></div><h3>Source</h3><pre><code>exports.token('response-time', function(req){
  return new Date - req._startTime;
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>UTC date</p></div><h3>Source</h3><pre><code>exports.token('date', function(){
  return new Date().toUTCString();
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>response status code</p></div><h3>Source</h3><pre><code>exports.token('status', function(req, res){
  return res.statusCode;
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>normalized referrer</p></div><h3>Source</h3><pre><code>exports.token('referrer', function(req){
  return req.headers['referer'] || req.headers['referrer'];
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>remote address</p></div><h3>Source</h3><pre><code>exports.token('remote-addr', function(req){
  return req.socket && (req.socket.remoteAddress || (req.socket.socket && req.socket.socket.remoteAddress));
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>HTTP version</p></div><h3>Source</h3><pre><code>exports.token('http-version', function(req){
  return req.httpVersionMajor + '.' + req.httpVersionMinor;
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>UA string</p></div><h3>Source</h3><pre><code>exports.token('user-agent', function(req){
  return req.headers['user-agent'];
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>request header</p></div><h3>Source</h3><pre><code>exports.token('req', function(req, res, field){
  return req.headers[field.toLowerCase()];
});</code></pre></div><div id="" class="comment"><h2></h2><div class="description"><p>response header</p></div><h3>Source</h3><pre><code>exports.token('res', function(req, res, field){
  return (res._headers || {})[field.toLowerCase()];
});</code></pre></div></div><ul id="menu"><li><a href="#"></a></li><li><a href="#compile">compile()</a></li><li><a href="#exports.token">exports.token()</a></li><li><a href="#exports.format">exports.format()</a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li><li><a href="#"></a></li></ul></body></html>